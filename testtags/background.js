/*! For license information please see background.js.LICENSE.txt */
(()=>{function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=c(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,i=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==t.return||t.return()}finally{if(i)throw a}}}}function t(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,o)}return t}function o(e){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?t(Object(o),!0).forEach(function(n){r(e,n,o[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):t(Object(o)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))})}return e}function r(n,t,o){return(t=function(n){var t=function(n){if("object"!=e(n)||!n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var o=t.call(n,"string");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(n)}(n);return"symbol"==e(t)?t:t+""}(t))in n?Object.defineProperty(n,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[t]=o,n}function a(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var o,r,a,c,s=[],i=!0,u=!1;try{if(a=(t=t.call(e)).next,0===n){if(Object(t)!==t)return;i=!1}else for(;!(i=(o=a.call(t)).done)&&(s.push(o.value),s.length!==n);i=!0);}catch(e){u=!0,r=e}finally{try{if(!i&&null!=t.return&&(c=t.return(),Object(c)!==c))return}finally{if(u)throw r}}return s}}(e,n)||c(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,n){if(e){if("string"==typeof e)return s(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?s(e,n):void 0}}function s(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,o=Array(n);t<n;t++)o[t]=e[t];return o}function i(){var e,n,t="function"==typeof Symbol?Symbol:{},o=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function a(t,o,r,a){var i=o&&o.prototype instanceof s?o:s,l=Object.create(i.prototype);return u(l,"_invoke",function(t,o,r){var a,s,i,u=0,l=r||[],d=!1,p={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(n,t){return a=n,s=0,i=e,p.n=t,c}};function g(t,o){for(s=t,i=o,n=0;!d&&u&&!r&&n<l.length;n++){var r,a=l[n],g=p.p,f=a[2];t>3?(r=f===o)&&(i=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=g&&((r=t<2&&g<a[1])?(s=0,p.v=o,p.n=a[1]):g<f&&(r=t<3||a[0]>o||o>f)&&(a[4]=t,a[5]=o,p.n=f,s=0))}if(r||t>1)return c;throw d=!0,o}return function(r,l,f){if(u>1)throw TypeError("Generator is already running");for(d&&1===l&&g(l,f),s=l,i=f;(n=s<2?e:i)||!d;){a||(s?s<3?(s>1&&(p.n=-1),g(s,i)):p.n=i:p.v=i);try{if(u=2,a){if(s||(r="next"),n=a[r]){if(!(n=n.call(a,i)))throw TypeError("iterator result is not an object");if(!n.done)return n;i=n.value,s<2&&(s=0)}else 1===s&&(n=a.return)&&n.call(a),s<2&&(i=TypeError("The iterator does not provide a '"+r+"' method"),s=1);a=e}else if((n=(d=p.n<0)?i:t.call(o,p))!==c)break}catch(n){a=e,s=1,i=n}finally{u=1}}return{value:n,done:d}}}(t,r,a),!0),l}var c={};function s(){}function l(){}function d(){}n=Object.getPrototypeOf;var p=[][o]?n(n([][o]())):(u(n={},o,function(){return this}),n),g=d.prototype=s.prototype=Object.create(p);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,u(e,r,"GeneratorFunction")),e.prototype=Object.create(g),e}return l.prototype=d,u(g,"constructor",d),u(d,"constructor",l),l.displayName="GeneratorFunction",u(d,r,"GeneratorFunction"),u(g),u(g,r,"Generator"),u(g,o,function(){return this}),u(g,"toString",function(){return"[object Generator]"}),(i=function(){return{w:a,m:f}})()}function u(e,n,t,o){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}u=function(e,n,t,o){function a(n,t){u(e,n,function(e){return this._invoke(n,t,e)})}n?r?r(e,n,{value:t,enumerable:!o,configurable:!o,writable:!o}):e[n]=t:(a("next",0),a("throw",1),a("return",2))},u(e,n,t,o)}function l(e,n,t,o,r,a,c){try{var s=e[a](c),i=s.value}catch(e){return void t(e)}s.done?n(i):Promise.resolve(i).then(o,r)}function d(e){return function(){var n=this,t=arguments;return new Promise(function(o,r){var a=e.apply(n,t);function c(e){l(a,o,r,c,s,"next",e)}function s(e){l(a,o,r,c,s,"throw",e)}c(void 0)})}}console.log("[CloudHub BG] Background script starting...");var p={encrypt:function(e,n){return d(i().m(function t(){var o,r;return i().w(function(t){for(;;)if(0===t.n){for(o="",r=0;r<e.length;r++)o+=String.fromCharCode(e.charCodeAt(r)^n.charCodeAt(r%n.length));return t.a(2,btoa(o))}},t)}))()},decrypt:function(e,n){return d(i().m(function t(){var o,r,a;return i().w(function(t){for(;;)if(0===t.n){for(o=atob(e),r="",a=0;a<o.length;a++)r+=String.fromCharCode(o.charCodeAt(a)^n.charCodeAt(a%n.length));return t.a(2,r)}},t)}))()},save:function(e,n){var t=this;return d(i().m(function o(){var r,c,s,u,l,d,p,g,f;return i().w(function(o){for(;;)switch(o.n){case 0:r=chrome.runtime.id,c={},s=0,u=Object.entries(n);case 1:if(!(s<u.length)){o.n=4;break}if(l=a(u[s],2),d=l[0],"string"!=typeof(p=l[1])||!p){o.n=3;break}return o.n=2,t.encrypt(p,r);case 2:c[d]=o.v;case 3:s++,o.n=1;break;case 4:return o.n=5,chrome.storage.local.get(["credentials"]);case 5:return g=o.v,(f=g.credentials||{})[e]=c,o.n=6,chrome.storage.local.set({credentials:f});case 6:return o.a(2,!0)}},o)}))()},load:function(e){var n=this;return d(i().m(function t(){var o,r,c,s,u,l,d,p,g,f;return i().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,chrome.storage.local.get(["credentials"]);case 1:if(r=t.v,c=null===(o=r.credentials)||void 0===o?void 0:o[e]){t.n=2;break}return t.a(2,null);case 2:s=chrome.runtime.id,u={},l=0,d=Object.entries(c);case 3:if(!(l<d.length)){t.n=6;break}if(p=a(d[l],2),g=p[0],"string"!=typeof(f=p[1])){t.n=5;break}return t.n=4,n.decrypt(f,s);case 4:u[g]=t.v;case 5:l++,t.n=3;break;case 6:return t.a(2,u)}},t)}))()}},g=function(e){return d(i().m(function n(){var t,o;return i().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,fetch("https://api.digitalocean.com/v2/account",{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});case 1:return t=n.v,n.a(2,t.ok);case 2:return n.p=2,o=n.v,console.error("DigitalOcean connection test failed:",o),n.a(2,!1)}},n,null,[[0,2]])}))()},f=function(e,n){return d(i().m(function t(){var o,r,a,c,s;return i().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,fetch("https://api.digitalocean.com/v2/droplets",{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});case 1:if((o=t.v).ok){t.n=2;break}throw new Error("HTTP ".concat(o.status,": ").concat(o.statusText));case 2:return t.n=3,o.json();case 3:if(r=t.v,a=r.droplets||[],!(c=a.find(function(e){return e.name===n}))){t.n=4;break}return t.a(2,{id:c.id,name:c.name,url:"https://cloud.digitalocean.com/droplets/".concat(c.id)});case 4:return t.a(2,{url:"https://cloud.digitalocean.com/droplets"});case 5:t.n=7;break;case 6:return t.p=6,s=t.v,console.error("Error getting DigitalOcean droplet info:",s),t.a(2,{url:"https://cloud.digitalocean.com/droplets"});case 7:return t.a(2)}},t,null,[[0,6]])}))()},v=function(e){return d(i().m(function n(){var t,o,r,a,c,s,u,l,d;return i().w(function(n){for(;;)switch(n.p=n.n){case 0:n.p=0,t=[],o="https://api.digitalocean.com/v2/droplets",console.log("[CloudHub] Fetching ALL DigitalOcean droplets with pagination...");case 1:return console.log("[CloudHub] Fetching page: ".concat(o)),n.n=2,fetch(o,{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});case 2:if((a=n.v).ok){n.n=3;break}throw new Error("HTTP ".concat(a.status,": ").concat(a.statusText));case 3:return n.n=4,a.json();case 4:c=n.v,s=c.droplets||[],t=t.concat(s),console.log("[CloudHub] Fetched ".concat(s.length," droplets. Total so far: ").concat(t.length)),o=(null===(r=c.links)||void 0===r||null===(r=r.pages)||void 0===r?void 0:r.next)||null;case 5:if(o){n.n=1;break}case 6:return console.log("[CloudHub] Finished fetching. Total droplets found: ".concat(t.length)),u=t.map(function(e){var n,t,o,r,a,c,s;return{id:"digitalocean:".concat(e.id),name:e.name,type:"droplet",status:e.status,publicIp:(null===(n=e.networks)||void 0===n||null===(n=n.v4)||void 0===n||null===(n=n.find(function(e){return"public"===e.type}))||void 0===n?void 0:n.ip_address)||null,privateIp:(null===(t=e.networks)||void 0===t||null===(t=t.v4)||void 0===t||null===(t=t.find(function(e){return"private"===e.type}))||void 0===t?void 0:t.ip_address)||null,region:(null===(o=e.region)||void 0===o?void 0:o.name)||(null===(r=e.region)||void 0===r?void 0:r.slug)||null,createdAt:e.created_at,size:(null===(a=e.size)||void 0===a?void 0:a.slug)||null,image:(null===(c=e.image)||void 0===c?void 0:c.name)||(null===(s=e.image)||void 0===s?void 0:s.slug)||null,tags:e.tags||[]}}),l=t.reduce(function(e,n){var t;return e+((null===(t=n.size)||void 0===t?void 0:t.price_monthly)||0)},0),n.a(2,{dropletCount:t.length,estimatedCost:l.toFixed(2),realCost:l.toFixed(2),resources:u,totalCost:l.toFixed(2)});case 7:return n.p=7,d=n.v,console.error("Error fetching DigitalOcean droplets:",d),n.a(2,{dropletCount:0,estimatedCost:"0.00",realCost:"0.00",resources:[],totalCost:"0.00"})}},n,null,[[0,7]])}))()},b={signRequest:function(e,n,t,o,r,a){var c=this;return d(i().m(function s(){var u,l,d,p,g,f,v,b,h,m,y,C,S,k,w,H,A;return i().w(function(s){for(;;)switch(s.n){case 0:return u="AWS4-HMAC-SHA256",l="".concat(n,".").concat(t,".amazonaws.com"),d=new Date,p=d.toISOString().replace(/[:\-]|\.\d{3}/g,""),g=d.toISOString().substring(0,10).replace(/-/g,""),f="host:".concat(l,"\nx-amz-date:").concat(p,"\n"),v="host;x-amz-date",s.n=1,c.sha256(r||"");case 1:return b=s.v,h="".concat(e,"\n").concat(o,"\n\n").concat(f,"\n").concat(v,"\n").concat(b),m=u,y="".concat(g,"/").concat(t,"/").concat(n,"/aws4_request"),H="".concat(m,"\n").concat(p,"\n").concat(y,"\n"),s.n=2,c.sha256(h);case 2:return A=s.v,C=H.concat.call(H,A),s.n=3,c.getSignatureKey(a.secretAccessKey,g,t,n);case 3:return S=s.v,s.n=4,c.hmacSha256(C,S);case 4:return k=s.v,w="".concat(m," Credential=").concat(a.accessKeyId,"/").concat(y,", SignedHeaders=").concat(v,", Signature=").concat(k),s.a(2,{Host:l,"X-Amz-Date":p,Authorization:w,"Content-Type":"application/x-amz-json-1.1"})}},s)}))()},sha256:function(e){return d(i().m(function n(){var t,o,r;return i().w(function(n){for(;;)switch(n.n){case 0:return t=(new TextEncoder).encode(e),n.n=1,crypto.subtle.digest("SHA-256",t);case 1:return o=n.v,r=Array.from(new Uint8Array(o)),n.a(2,r.map(function(e){return e.toString(16).padStart(2,"0")}).join(""))}},n)}))()},hmacSha256:function(e,n){return d(i().m(function t(){var o,r,a,c,s,u;return i().w(function(t){for(;;)switch(t.n){case 0:return o=new TextEncoder,r="string"==typeof n?o.encode(n):n,a=o.encode(e),t.n=1,crypto.subtle.importKey("raw",r,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);case 1:return c=t.v,t.n=2,crypto.subtle.sign("HMAC",c,a);case 2:return s=t.v,u=Array.from(new Uint8Array(s)),t.a(2,u.map(function(e){return e.toString(16).padStart(2,"0")}).join(""))}},t)}))()},getSignatureKey:function(e,n,t,o){var r=this;return d(i().m(function a(){var c,s,u,l;return i().w(function(a){for(;;)switch(a.n){case 0:return a.n=1,r.hmacSha256Bytes(n,"AWS4".concat(e));case 1:return c=a.v,a.n=2,r.hmacSha256Bytes(t,c);case 2:return s=a.v,a.n=3,r.hmacSha256Bytes(o,s);case 3:return u=a.v,a.n=4,r.hmacSha256Bytes("aws4_request",u);case 4:return l=a.v,a.a(2,l)}},a)}))()},hmacSha256Bytes:function(e,n){return d(i().m(function t(){var o,r,a,c;return i().w(function(t){for(;;)switch(t.n){case 0:return o=new TextEncoder,r="string"==typeof n?o.encode(n):n,a=o.encode(e),t.n=1,crypto.subtle.importKey("raw",r,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);case 1:return c=t.v,t.n=2,crypto.subtle.sign("HMAC",c,a);case 2:return t.a(2,t.v)}},t)}))()},testConnection:function(e){var n=this;return d(i().m(function t(){var r,a,c;return i().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,n.signRequest("POST","sts",e.region||"us-east-1","/","",e);case 1:return r=t.v,t.n=2,fetch("https://sts.".concat(e.region||"us-east-1",".amazonaws.com/"),{method:"POST",headers:o(o({},r),{},{"X-Amz-Target":"AWSSecurityTokenServiceV20110615.GetCallerIdentity"}),body:"{}"});case 2:return a=t.v,t.a(2,a.ok);case 3:return t.p=3,c=t.v,console.error("AWS connection test failed:",c),t.a(2,!1)}},t,null,[[0,3]])}))()},getEC2Instances:function(e){var n=this;return d(i().m(function t(){var r,a,c,s,u,l,d,p,g,f,v,b,h;return i().w(function(t){for(;;)switch(t.p=t.n){case 0:t.p=0,r=e.region&&e.region.trim()&&"all"!==e.region?[e.region]:["us-east-1","us-east-2","us-west-1","us-west-2","eu-west-1","eu-west-2","eu-west-3","eu-central-1","eu-north-1","ap-southeast-1","ap-southeast-2","ap-northeast-1","ap-northeast-2","ap-northeast-3","ap-south-1","ap-south-2","ca-central-1","sa-east-1","eu-south-1","eu-south-2","me-south-1","me-central-1","af-south-1","ap-east-1","us-gov-east-1","us-gov-west-1"],console.log("[CloudHub BG] AWS: Will scan ".concat(r.length," regions:"),r.join(", ")),a=[],c=0,s=0,u=r;case 1:if(!(s<u.length)){t.n=11;break}return l=u[s],t.p=2,console.log("[CloudHub BG] AWS: Fetching instances from region ".concat(l)),t.n=3,n.signRequest("POST","ec2",l,"/","Action=DescribeInstances&Version=2016-11-15",e);case 3:return d=t.v,console.log("[CloudHub BG] AWS: Making request to https://ec2.".concat(l,".amazonaws.com/")),t.n=4,fetch("https://ec2.".concat(l,".amazonaws.com/"),{method:"POST",headers:o(o({},d),{},{"Content-Type":"application/x-www-form-urlencoded"}),body:"Action=DescribeInstances&Version=2016-11-15"});case 4:if(p=t.v,console.log("[CloudHub BG] AWS: Response status for ".concat(l,": ").concat(p.status," ").concat(p.statusText)),!p.ok){t.n=6;break}return t.n=5,p.text();case 5:g=t.v,console.log("[CloudHub BG] AWS: Received XML response from ".concat(l," (").concat(g.length," chars)")),console.log("[CloudHub BG] AWS: XML preview:",g.substring(0,500)),g.includes("<instancesSet>")&&g.includes("<instanceId>")&&(console.log("[CloudHub BG] AWS: FULL XML DUMP for ".concat(l,":")),console.log(g)),f=n.parseEC2Response(g,l),console.log("[CloudHub BG] AWS: Parsed ".concat(f.length," instances from ").concat(l)),0===f.length&&g.includes("<instancesSet>")&&(console.log("[CloudHub BG] AWS: Warning - XML contains instancesSet but parsed 0 instances. XML length: ".concat(g.length)),console.log("[CloudHub BG] AWS: First 1000 chars:",g.substring(0,1e3))),a=a.concat(f),c+=25*f.length,t.n=8;break;case 6:return t.n=7,p.text();case 7:v=t.v,console.error("[CloudHub BG] AWS: Error response from ".concat(l,":"),v);case 8:t.n=10;break;case 9:t.p=9,b=t.v,console.log("[CloudHub BG] AWS: Failed to get instances from region ".concat(l,":"),b);case 10:s++,t.n=1;break;case 11:return console.log("[CloudHub BG] AWS: Scanning complete. Found ".concat(a.length," instances across ").concat(r.length," regions")),t.a(2,{ec2Count:a.length,estimatedCost:c.toFixed(2),resources:a});case 12:return t.p=12,h=t.v,console.error("Error fetching AWS EC2 instances:",h),t.a(2,{ec2Count:0,estimatedCost:"0.00",resources:[]})}},t,null,[[2,9],[0,12]])}))()},parseEC2Response:function(e,n){var t=this,o=[];try{console.log("[CloudHub BG] AWS: Starting to parse XML for region ".concat(n));var r=e.match(/<instancesSet>[\s\S]*?<\/instancesSet>/g)||[];console.log("[CloudHub BG] AWS: Found ".concat(r.length," instancesSet blocks")),r.forEach(function(e){console.log("[CloudHub BG] AWS: instancesSet XML preview:",e.substring(0,300));var r=e.match(/<item>[\s\S]*?<\/item>/g)||[];console.log("[CloudHub BG] AWS: Found ".concat(r.length," instance items in this instancesSet")),r.forEach(function(e){var r=t.extractXmlValue(e,"instanceId"),a=t.extractXmlValue(e,"instanceType"),c=e.match(/<instanceState>([\s\S]*?)<\/instanceState>/),s="unknown";c&&(s=t.extractXmlValue(c[1],"name")||"unknown");var i=t.extractXmlValue(e,"ipAddress"),u=t.extractXmlValue(e,"launchTime");console.log("[CloudHub BG] AWS: Found instance ".concat(r,", type: ").concat(a,", state: ").concat(s));var l=r,d=e.match(/<tagSet>([\s\S]*?)<\/tagSet>/);d&&(d[1].match(/<item>[\s\S]*?<\/item>/g)||[]).forEach(function(e){var n=t.extractXmlValue(e,"key"),o=t.extractXmlValue(e,"value");"Name"===n&&o&&(l=o)}),console.log("[CloudHub BG] AWS: Instance details - ID: ".concat(r,", Name: ").concat(l,", Type: ").concat(a,", State: ").concat(s,", IP: ").concat(i||"none")),r&&o.push({id:"aws:".concat(r),name:l||r,type:a||"unknown",status:s,publicIp:i||null,region:n,createdAt:u})})})}catch(e){console.error("Error parsing EC2 XML response:",e)}return o},extractXmlValue:function(e,n){var t=new RegExp("<".concat(n,"[^>]*>([^<]*)</").concat(n.split(".*?")[0],">"),"i"),o=e.match(t);return o?o[1].trim():null}};chrome.runtime.onMessage.addListener(function(e,t,o){return console.log("[CloudHub BG] Message received:",e),d(i().m(function t(){var r,a,c,s,u,l,d,h,m,y,C,S,k,w,H,A,B,G,O,T,E,j,I,P,W,x,F,D,z,_,M,N,X,U,L,K,R,V,q,J,$,Q,Y,Z,ee,ne,te,oe,re,ae,ce;return i().w(function(t){for(;;)switch(t.p=t.n){case 0:t.p=0,$=e.action,t.n="saveCredentials"===$?1:"testConnection"===$?3:"getProviderDetails"===$?14:"refreshAllProviders"===$?22:"getDropletSSHInfo"===$?31:"simulateSSHClick"===$?36:"performResourceAction"===$?48:"updateDropletTags"===$?59:"getDropletTags"===$?90:102;break;case 1:return console.log("[CloudHub BG] Saving credentials for ".concat(e.provider)),t.n=2,p.save(e.provider,e.credentials);case 2:return console.log("[CloudHub BG] Credentials saved for ".concat(e.provider)),o({success:!0}),t.a(3,103);case 3:if(console.log("[CloudHub BG] Testing connection for ".concat(e.provider)),r=!1,"digitalocean"!==e.provider){t.n=7;break}return t.n=4,p.load("digitalocean");case 4:if(null==(a=t.v)||!a.token){t.n=6;break}return t.n=5,g(a.token);case 5:r=t.v;case 6:t.n=13;break;case 7:if("aws"!==e.provider){t.n=11;break}return t.n=8,p.load("aws");case 8:if(null==(c=t.v)||!c.accessKeyId||null==c||!c.secretAccessKey){t.n=10;break}return t.n=9,b.testConnection(c);case 9:r=t.v;case 10:t.n=13;break;case 11:return t.n=12,p.load(e.provider);case 12:s=t.v,r=null!==s;case 13:return console.log("[CloudHub BG] Connection test result for ".concat(e.provider,":"),r),o({success:r,error:r?null:"Connection failed"}),t.a(3,103);case 14:if(console.log("[CloudHub BG] Getting provider details for ".concat(e.provider)),u={dropletCount:0,ec2Count:0,computeCount:0,vmCount:0,estimatedCost:"0.00",resources:[]},"digitalocean"!==e.provider){t.n=18;break}return t.n=15,p.load("digitalocean");case 15:if(null==(l=t.v)||!l.token){t.n=17;break}return t.n=16,v(l.token);case 16:u=t.v;case 17:t.n=21;break;case 18:if("aws"!==e.provider){t.n=21;break}return t.n=19,p.load("aws");case 19:if(null==(d=t.v)||!d.accessKeyId||null==d||!d.secretAccessKey){t.n=21;break}return t.n=20,b.getEC2Instances(d);case 20:u=t.v;case 21:return console.log("[CloudHub BG] Provider data for ".concat(e.provider,":"),u),o({success:!0,data:u}),t.a(3,103);case 22:return console.log("[CloudHub BG] Refreshing all providers"),h={},t.n=23,p.load("digitalocean");case 23:if(null==(m=t.v)||!m.token){t.n=25;break}return t.n=24,v(m.token);case 24:h.digitalocean=t.v,t.n=26;break;case 25:h.digitalocean={dropletCount:0,estimatedCost:"0.00",resources:[]};case 26:return t.n=27,p.load("aws");case 27:if(null==(y=t.v)||!y.accessKeyId||null==y||!y.secretAccessKey){t.n=29;break}return t.n=28,b.getEC2Instances(y);case 28:h.aws=t.v,t.n=30;break;case 29:h.aws={ec2Count:0,estimatedCost:"0.00",resources:[]};case 30:return h.gcp={computeCount:0,estimatedCost:"0.00",resources:[]},h.azure={vmCount:0,estimatedCost:"0.00",resources:[]},o({success:!0,data:h}),t.a(3,103);case 31:return console.log("[CloudHub BG] Getting SSH info for droplet: ".concat(e.dropletName)),t.n=32,p.load("digitalocean");case 32:if(null==(C=t.v)||!C.token){t.n=34;break}return t.n=33,f(C.token,e.dropletName);case 33:S=t.v,o({success:!0,dropletUrl:S.url}),t.n=35;break;case 34:o({success:!1,error:"No DigitalOcean credentials found"});case 35:return t.a(3,103);case 36:if(console.log("[CloudHub BG] Simulating SSH click for ".concat(e.provider," instance: ").concat(e.instanceName)),"digitalocean"!==e.provider){t.n=41;break}return console.log("[CloudHub BG] Opening DigitalOcean droplet console for ".concat(e.instanceName," (").concat(e.instanceId,")")),k="https://cloud.digitalocean.com/droplets/".concat(e.instanceId,"/terminal/ui/?os_user=root"),t.p=37,t.n=38,chrome.tabs.create({url:k,active:!0});case 38:console.log("[CloudHub BG] Opened SSH terminal for ".concat(e.instanceName," at ").concat(k)),o({success:!0,message:"SSH terminal opened for ".concat(e.instanceName),action:"terminal_opened",terminalUrl:k}),t.n=40;break;case 39:t.p=39,Q=t.v,console.error("[CloudHub BG] Error opening SSH terminal:",Q),o({success:!1,error:"Failed to open SSH terminal: ".concat(Q.message)});case 40:t.n=47;break;case 41:if("aws"!==e.provider){t.n=46;break}return console.log("[CloudHub BG] Opening AWS EC2 Instance Connect for ".concat(e.instanceName," (").concat(e.instanceId,")")),w=e.region||"us-east-1",H=e.osUser||"ubuntu",A="https://".concat(w,".console.aws.amazon.com/ec2-instance-connect/ssh?region=").concat(w,"&connType=standard&instanceId=").concat(e.instanceId,"&osUser=").concat(H,"&sshPort=22&addressFamily=ipv4"),t.p=42,t.n=43,chrome.tabs.create({url:A,active:!0});case 43:console.log("[CloudHub BG] Opened AWS EC2 Instance Connect for ".concat(e.instanceName," at ").concat(A)),o({success:!0,message:"AWS EC2 Instance Connect opened for ".concat(e.instanceName),action:"instance_connect_opened",instanceConnectUrl:A}),t.n=45;break;case 44:t.p=44,Y=t.v,console.error("[CloudHub BG] Error opening AWS EC2 Instance Connect:",Y),o({success:!1,error:"Failed to open AWS EC2 Instance Connect: ".concat(Y.message)});case 45:t.n=47;break;case 46:o({success:!1,error:"SSH simulation not implemented for ".concat(e.provider)});case 47:return t.a(3,103);case 48:if(console.log("[CloudHub BG] Performing resource action: ".concat(e.resourceAction," on ").concat(e.resourceId)),"delete"!==e.resourceAction||!e.resourceId.startsWith("digitalocean:")){t.n=57;break}return B=e.resourceId.replace("digitalocean:",""),t.n=49,p.load("digitalocean");case 49:if(null!=(G=t.v)&&G.token){t.n=50;break}return o({success:!1,error:"DigitalOcean credentials not found"}),t.a(3,103);case 50:return t.p=50,console.log("[CloudHub BG] Deleting DigitalOcean droplet ".concat(B)),t.n=51,fetch("https://api.digitalocean.com/v2/droplets/".concat(B),{method:"DELETE",headers:{Authorization:"Bearer ".concat(G.token),"Content-Type":"application/json"}});case 51:if(!(O=t.v).ok&&204!==O.status){t.n=52;break}console.log("[CloudHub BG] Successfully deleted droplet ".concat(B)),o({success:!0,message:"Droplet ".concat(B," deleted successfully")}),t.n=54;break;case 52:return t.n=53,O.text();case 53:T=t.v,console.error("[CloudHub BG] Failed to delete droplet ".concat(B,":"),T),o({success:!1,error:"Failed to delete droplet: HTTP ".concat(O.status)});case 54:t.n=56;break;case 55:t.p=55,Z=t.v,console.error("[CloudHub BG] Error deleting droplet ".concat(B,":"),Z),o({success:!1,error:"Error deleting droplet: ".concat(Z.message)});case 56:t.n=58;break;case 57:o({success:!1,error:"Unsupported resource action: ".concat(e.resourceAction," for ").concat(e.resourceId)});case 58:return t.a(3,103);case 59:if(console.log("[CloudHub BG] Updating tags for droplet: ".concat(e.instanceId)),!e.instanceId.startsWith("digitalocean:")){t.n=88;break}return E=e.instanceId.replace("digitalocean:",""),t.n=60,p.load("digitalocean");case 60:if(null!=(j=t.v)&&j.token){t.n=61;break}return o({success:!1,error:"DigitalOcean credentials not found"}),t.a(3,103);case 61:return t.p=61,I=e.tags.map(function(e){return e.trim()}).filter(function(e){return e.length>0}),console.log("[CloudHub BG] Updating tags for droplet ".concat(E," to:"),I),console.log("[CloudHub BG] Original tags from UI:",e.tags),t.n=62,fetch("https://api.digitalocean.com/v2/droplets/".concat(E),{headers:{Authorization:"Bearer ".concat(j.token),"Content-Type":"application/json"}});case 62:if((P=t.v).ok){t.n=63;break}throw new Error("Failed to get droplet: HTTP ".concat(P.status));case 63:return t.n=64,P.json();case 64:W=t.v,x=W.droplet.tags||[],F=x.filter(function(e){return!I.includes(e)}),D=I.filter(function(e){return!x.includes(e)}),console.log("[CloudHub BG] Current tags:",x),console.log("[CloudHub BG] Sanitized tags:",I),console.log("[CloudHub BG] Tags to remove:",F),console.log("[CloudHub BG] Tags to add:",D),z=n(F),t.p=65,z.s();case 66:if((_=z.n()).done){t.n=71;break}return M=_.value,t.p=67,t.n=68,fetch("https://api.digitalocean.com/v2/tags/".concat(M,"/resources"),{method:"DELETE",headers:{Authorization:"Bearer ".concat(j.token),"Content-Type":"application/json"},body:JSON.stringify({resources:[{resource_id:E,resource_type:"droplet"}]})});case 68:console.log("[CloudHub BG] Removed tag: ".concat(M)),t.n=70;break;case 69:t.p=69,ee=t.v,console.error("[CloudHub BG] Failed to remove tag ".concat(M,":"),ee);case 70:t.n=66;break;case 71:t.n=73;break;case 72:t.p=72,ne=t.v,z.e(ne);case 73:return t.p=73,z.f(),t.f(73);case 74:N=n(D),t.p=75,N.s();case 76:if((X=N.n()).done){t.n=82;break}return U=X.value,t.p=77,t.n=78,fetch("https://api.digitalocean.com/v2/tags",{method:"POST",headers:{Authorization:"Bearer ".concat(j.token),"Content-Type":"application/json"},body:JSON.stringify({name:U})});case 78:return t.n=79,fetch("https://api.digitalocean.com/v2/tags/".concat(U,"/resources"),{method:"POST",headers:{Authorization:"Bearer ".concat(j.token),"Content-Type":"application/json"},body:JSON.stringify({resources:[{resource_id:E,resource_type:"droplet"}]})});case 79:t.v.ok?console.log("[CloudHub BG] Added tag: ".concat(U)):console.error("[CloudHub BG] Failed to assign tag ".concat(U," to droplet")),t.n=81;break;case 80:t.p=80,te=t.v,console.error("[CloudHub BG] Error adding tag ".concat(U,":"),te);case 81:t.n=76;break;case 82:t.n=84;break;case 83:t.p=83,oe=t.v,N.e(oe);case 84:return t.p=84,N.f(),t.f(84);case 85:console.log("[CloudHub BG] Successfully updated tags for droplet ".concat(E)),console.log("[CloudHub BG] New tags should be:",I),o({success:!0,message:"Tags updated successfully for ".concat(e.instanceName)}),t.n=87;break;case 86:t.p=86,re=t.v,console.error("[CloudHub BG] Error updating tags for droplet ".concat(E,":"),re),o({success:!1,error:"Error updating tags: ".concat(re.message)});case 87:t.n=89;break;case 88:o({success:!1,error:"Tag updates only supported for DigitalOcean droplets"});case 89:return t.a(3,103);case 90:if(console.log("[CloudHub BG] Getting fresh tags for droplet: ".concat(e.instanceId)),!e.instanceId.startsWith("digitalocean:")){t.n=100;break}return L=e.instanceId.replace("digitalocean:",""),t.n=91,p.load("digitalocean");case 91:if(null!=(K=t.v)&&K.token){t.n=92;break}return o({success:!1,error:"DigitalOcean credentials not found"}),t.a(3,103);case 92:return t.p=92,console.log("[CloudHub BG] Fetching fresh tags for droplet ".concat(L)),t.n=93,fetch("https://api.digitalocean.com/v2/droplets/".concat(L),{headers:{Authorization:"Bearer ".concat(K.token),"Content-Type":"application/json"}});case 93:if(!(R=t.v).ok){t.n=95;break}return t.n=94,R.json();case 94:V=t.v,q=V.droplet.tags||[],console.log("[CloudHub BG] Fresh tags for droplet ".concat(L,":"),q),o({success:!0,tags:q}),t.n=97;break;case 95:return t.n=96,R.text();case 96:J=t.v,console.error("[CloudHub BG] Failed to get droplet tags ".concat(L,":"),J),o({success:!1,error:"Failed to get tags: HTTP ".concat(R.status)});case 97:t.n=99;break;case 98:t.p=98,ae=t.v,console.error("[CloudHub BG] Error getting droplet tags ".concat(L,":"),ae),o({success:!1,error:"Error getting tags: ".concat(ae.message)});case 99:t.n=101;break;case 100:o({success:!1,error:"Tag refresh only supported for DigitalOcean droplets"});case 101:return t.a(3,103);case 102:console.log("[CloudHub BG] Unknown action: ".concat(e.action)),o({success:!1,error:"Unknown action"});case 103:t.n=105;break;case 104:t.p=104,ce=t.v,console.error("[CloudHub BG] Error handling message:",ce),o({success:!1,error:ce.message});case 105:return t.a(2)}},t,null,[[92,98],[77,80],[75,83,84,85],[67,69],[65,72,73,74],[61,86],[50,55],[42,44],[37,39],[0,104]])}))(),!0}),console.log("[CloudHub BG] Background script loaded successfully")})();